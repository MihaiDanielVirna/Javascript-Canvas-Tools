(function(){var k=Math.floor,l=Math.random,o=Math.pow,q=Math.min,r=Math.max,s=function(a,c){if(arguments.length>2)for(var d=1;d<arguments.length;d++)s(a,arguments[d]);else for(d in c)a[d]=c[d];return a},h={Filters:{grayscale:{defaults:{weighted:!0},method:function(a,c,d,e,f){a=a.weighted?(c*1.299+d*1.587+e*1.114)/3:(c+d+e)/3;return[a,a,a,f]}},noiseGray:{defaults:{min:0,max:255,opacity:0.5},method:function(a,c,d,e,f){var b=k(a.min+l()*(a.max-a.min)),g=[];g[0]=a.opacity*b+(1-a.opacity)*c;g[1]=a.opacity*
b+(1-a.opacity)*d;g[2]=a.opacity*b+(1-a.opacity)*e;g[3]=f;return g}},noiseColor:{defaults:{min:0,max:100,rgb:[255,0,0]},method:function(a,c,d,e,f){var b=k(a.min+l()*(a.max-a.min))/100,g=[];g[0]=b*a.rgb[0]+(1-b)*c;g[1]=b*a.rgb[1]+(1-b)*d;g[2]=b*a.rgb[2]+(1-b)*e;g[3]=f;return g}},noiseRandom:{defaults:{opacity:0.5},method:function(a,c,d,e,f){var b=k(l()*255),g=k(l()*255);k(l()*255);var j=[];j[0]=a.opacity*b+(1-a.opacity)*c;j[1]=a.opacity*g+(1-a.opacity)*d;j[2]=a.opacity*b+(1-a.opacity)*e;j[3]=f;return j}},
invert:{defaults:{},method:function(a,c,d,e,f){a=[];a[0]=255-c;a[1]=255-d;a[2]=255-e;a[3]=f;return a}}},Adjustments:{levels:{defaults:{gamma:1,input:{min:0,max:255},output:{min:0,max:255}},method:function(a,c,d,e,f){var b=a.input.min/255,g=a.input.max/255,j=a.output.min/255,h=a.output.max/255;p=[];p[0]=(j+(h-j)*o(q(r(c/255-b,0)/(g-b),1),1/a.gamma))*255;p[1]=(j+(h-j)*o(q(r(d/255-b,0)/(g-b),1),1/a.gamma))*255;p[2]=(j+(h-j)*o(q(r(e/255-b,0)/(g-b),1),1/a.gamma))*255;p[3]=f;return p}}},Blends:{linearBurn:function(a,
c,d,e,f,b,g,j,n){or=f+a<255?0:f+a-255;og=b+c<255?0:b+c-255;ob=g+d<255?0:g+d-255;return h.Blends.normal(or,og,ob,e,f,b,g,j,n)},normal:function(a,c,d,e,f,b,g,h,n){var k=e*n/255,l=1-k,m=[];m[0]=k*a+l*f;m[1]=k*c+l*b;m[2]=k*d+l*g;m[3]=e*n+h*l;return m},multiply:function(a,c,d,e,f,b,g,j,k){t=f*a+128;or=(t>>8)+t>>8;t=b*c+128;og=(t>>8)+t>>8;t=g*d+128;ob=(t>>8)+t>>8;return h.Blends.normal(or,og,ob,e,f,b,g,j,k)},screen:function(a,c,d,e,f,b,g,j,k){or=255-(255-a)*(255-f)/255;og=255-(255-c)*(255-b)/255;ob=255-
(255-d)*(255-g)/255;return h.Blends.normal(or,og,ob,e,f,b,g,j,k)}},Canvas:function(a){this.context=this.canvas=null;this.setCanvas(a)}};h.Canvas.prototype.adjust=function(a,c,d){var e,f={},c=c||[{}],d=d||{};if("string"==typeof a)a=[a];else if(!a instanceof Array)throw Error("'adjustments' argument should be a string or array of strings referring to available adjustments.");"undefined"==typeof c.length&&(c=[c]);for(e=0;e<a.length;e++)f[a[e]]=s(h.Adjustments[a[e]].defaults,c[e]);"function"==typeof d.pre&&
d.pre.apply(this);var c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=c.data;for(i=0;i<b.length;i+=4)for(e=0;e<a.length;e++)p=h.Adjustments[a[e]].method(f[a[e]],b[i],b[i+1],b[i+2],b[i+3]),b[i]=p[0],b[i+1]=p[1],b[i+2]=p[2],b[i+3]=p[3];this.setImageData(c);"function"==typeof d.post&&d.post.apply(this);return this};h.Canvas.prototype.filter=function(a,c,d){var e={};c=c||[{}];d=d||{};if("string"==typeof a)a=[a];else if(!a instanceof Array)throw Error("filters argument should be a string or array.");
"undefined"==typeof c.length&&(c=[c]);for(var f=0;f<a.length;f++)e[a[f]]=s(h.Filters[a[f]].defaults,c[f]);"function"==typeof d.pre&&d.pre.apply(this);var c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=c.data;for(i=0;i<b.length;i+=4)for(f=0;f<a.length;f++)p=h.Filters[a[f]].method(e[a[f]],b[i],b[i+1],b[i+2],b[i+3]),b[i]=p[0],b[i+1]=p[1],b[i+2]=p[2],b[i+3]=p[3];this.setImageData(c);"function"==typeof d.post&&d.post.apply(this);return this};h.Canvas.prototype.blend=function(a,
c,d,e){if("string"!=typeof a||!a in h.Blends)throw Error("'mode' argument should be a string, and should refer to an available blending mode.");if(!c instanceof h.Canvas)throw Error("'top' argument must be an instance of CanvasTools.Canvas");if("number"!=typeof d||d<0||d>1)d=1;e=e||{};"function"==typeof e.pre&&e.pre.apply(this);var f=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=f.data,c=c.context.getImageData(0,0,c.canvas.width,c.canvas.height).data;for(i=0;i<c.length;i+=
4)p=h.Blends[a](c[i],c[i+1],c[i+2],c[i+3],b[i],b[i+1],b[i+2],b[i+3],d),b[i]=p[0],b[i+1]=p[1],b[i+2]=p[2],b[i+3]=p[3];this.setImageData(f);"function"==typeof e.post&&e.post.apply(this);return this};h.Canvas.prototype.setCanvas=function(a){a=typeof a=="string"&&a.length>0?document.getElementById(a):document.createElement("canvas");if(!0===a instanceof HTMLImageElement){var c=document.createElement("canvas");c.width=a.width;c.height=a.height;c.getContext("2d").drawImage(a,0,0);a=c}if(!1===a instanceof
HTMLCanvasElement)throw Error("canvas is required as HTMLCanvasElement, HTMLImageElement, or a string representing the id of a canvas or img element.");this.canvas=a;this.context=this.canvas.getContext("2d");return this};h.Canvas.prototype.setImageData=function(a){this.context.putImageData(a,0,0)};h.Canvas.prototype.getPNG=function(){return this.canvas.toDataURL("image/png")};if("CanvasTools"in window)throw Error("'CanvasTools' is already defined in the window object.");else window.CanvasTools=h})();