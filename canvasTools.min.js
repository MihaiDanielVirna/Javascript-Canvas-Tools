(function(){var j=Math.floor,l=Math.random,n=Math.pow,o=Math.min,q=Math.max,r=function(a,b){if(arguments.length>2)for(var d=1;d<arguments.length;d++)r(a,arguments[d]);else for(d in b)a[d]=b[d];return a},g={Filters:{grayscale:{defaults:{weighted:!0},method:function(a,b,d,e,f){a=a.weighted?(b*1.299+d*1.587+e*1.114)/3:(b+d+e)/3;return[a,a,a,f]}},noiseGray:{defaults:{min:0,max:255,opacity:0.5},method:function(a,b,d,e,f){var c=j(a.min+l()*(a.max-a.min)),h=[];h[0]=a.opacity*c+(1-a.opacity)*b;h[1]=a.opacity*
c+(1-a.opacity)*d;h[2]=a.opacity*c+(1-a.opacity)*e;h[3]=f;return h}},noiseColor:{defaults:{min:0,max:100,rgb:[255,0,0]},method:function(a,b,d,e,f){var c=j(a.min+l()*(a.max-a.min))/100,h=[];h[0]=c*a.rgb[0]+(1-c)*b;h[1]=c*a.rgb[1]+(1-c)*d;h[2]=c*a.rgb[2]+(1-c)*e;h[3]=f;return h}},noiseRandom:{defaults:{opacity:0.5},method:function(a,b,d,e,f){var c=j(l()*255),h=j(l()*255);j(l()*255);var g=[];g[0]=a.opacity*c+(1-a.opacity)*b;g[1]=a.opacity*h+(1-a.opacity)*d;g[2]=a.opacity*c+(1-a.opacity)*e;g[3]=f;return g}},
invert:{defaults:{},method:function(a,b,d,e,f){a=[];a[0]=255-b;a[1]=255-d;a[2]=255-e;a[3]=f;return a}}},Adjustments:{levels:{defaults:{gamma:1,input:{min:0,max:255},output:{min:0,max:255}},method:function(a,b,d,e,f){var c=a.input.min/255,h=a.input.max/255,g=a.output.min/255,k=a.output.max/255;p=[];p[0]=(g+(k-g)*n(o(q(b/255-c,0)/(h-c),1),1/a.gamma))*255;p[1]=(g+(k-g)*n(o(q(d/255-c,0)/(h-c),1),1/a.gamma))*255;p[2]=(g+(k-g)*n(o(q(e/255-c,0)/(h-c),1),1/a.gamma))*255;p[3]=f;return p}}},Blends:{linearBurn:function(a,
b,d,e,f,c,h,s,k){or=f+a<255?0:f+a-255;og=c+b<255?0:c+b-255;ob=h+d<255?0:h+d-255;return g.Blends.normal(or,og,ob,e,f,c,h,s,k)},normal:function(a,b,d,e,f,c,g,s,k){var j=e*k/255,l=1-j,m=[];m[0]=j*a+l*f;m[1]=j*b+l*c;m[2]=j*d+l*g;m[3]=e*k+s*l;return m},multiply:function(a,b,d,e,f,c,h,j,k){t=f*a+128;or=(t>>8)+t>>8;t=c*b+128;og=(t>>8)+t>>8;t=h*d+128;ob=(t>>8)+t>>8;return g.Blends.normal(or,og,ob,e,f,c,h,j,k)},screen:function(a,b,d,e,f,c,h,j,k){or=255-(255-a)*(255-f)/255;og=255-(255-b)*(255-c)/255;ob=255-
(255-d)*(255-h)/255;return g.Blends.normal(or,og,ob,e,f,c,h,j,k)}},Canvas:function(a){this.context=this.canvas=null;this.setCanvas(a)}};g.Canvas.prototype.adjust=function(a,b,d){var e,f={},b=b||[{}],d=d||{};if("string"==typeof a)a=[a];else if(!a instanceof Array)throw Error("'adjustments' argument should be a string or array of strings referring to available adjustments.");"undefined"==typeof b.length&&(b=[b]);for(e=0;e<a.length;e++)f[a[e]]=r(g.Adjustments[a[e]].defaults,b[e]);"function"==typeof d.pre&&
d.pre.apply(this);var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data;for(i=0;i<c.length;i+=4)for(e=0;e<a.length;e++)p=g.Adjustments[a[e]].method(f[a[e]],c[i],c[i+1],c[i+2],c[i+3]),c[i]=p[0],c[i+1]=p[1],c[i+2]=p[2],c[i+3]=p[3];this.setImageData(b);"function"==typeof d.post&&d.post.apply(this);return this};g.Canvas.prototype.filter=function(a,b,d){var e={};b=b||[{}];d=d||{};if("string"==typeof a)a=[a];else if(!a instanceof Array)throw Error("filters argument should be a string or array.");
"undefined"==typeof b.length&&(b=[b]);for(var f=0;f<a.length;f++)e[a[f]]=r(g.Filters[a[f]].defaults,b[f]);"function"==typeof d.pre&&d.pre.apply(this);var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data;for(i=0;i<c.length;i+=4)for(f=0;f<a.length;f++)p=g.Filters[a[f]].method(e[a[f]],c[i],c[i+1],c[i+2],c[i+3]),c[i]=p[0],c[i+1]=p[1],c[i+2]=p[2],c[i+3]=p[3];this.setImageData(b);"function"==typeof d.post&&d.post.apply(this);return this};g.Canvas.prototype.blend=function(a,
b,d,e){if("string"!=typeof a||!a in g.Blends)throw Error("'mode' argument should be a string, and should refer to an available blending mode.");if(!b instanceof g.Canvas)throw Error("'top' argument must be an instance of CanvasTools.Canvas");if("number"!=typeof d||d<0||d>1)d=1;e=e||{};"function"==typeof e.pre&&e.pre.apply(this);var f=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=f.data,b=b.context.getImageData(0,0,b.canvas.width,b.canvas.height).data;for(i=0;i<b.length;i+=
4)p=g.Blends[a](b[i],b[i+1],b[i+2],b[i+3],c[i],c[i+1],c[i+2],c[i+3],d),c[i]=p[0],c[i+1]=p[1],c[i+2]=p[2],c[i+3]=p[3];this.setImageData(f);"function"==typeof e.post&&e.post.apply(this);return this};g.Canvas.prototype.setCanvas=function(a){a=typeof a=="string"&&a.length>0?document.getElementById(a):document.createElement("canvas");if(!0===a instanceof HTMLImageElement){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;b.getContext("2d").drawImage(a,0,0);a=b}if(!1===a instanceof
HTMLCanvasElement)throw Error("canvas is required as HTMLCanvasElement, HTMLImageElement, or a string representing the id of a canvas or img element.");this.canvas=a;this.context=this.canvas.getContext("2d");return this};g.Canvas.prototype.setImageData=function(a){this.context.putImageData(a,0,0)};g.Canvas.prototype.getPNG=function(){return this.canvas.toDataURL("image/png")};g.Canvas.prototype.setDimensions=function(a,b){this.canvas.width=a;this.canvas.height=b;return this};g.Canvas.prototype.getWidth=
function(){return this.canvas.width};g.Canvas.prototype.getHeight=function(){return this.canvas.height};if("CanvasTools"in window)throw Error("'CanvasTools' is already defined in the window object.");else window.CanvasTools=g})();